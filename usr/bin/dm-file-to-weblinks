#!/bin/bash

#set -x
set -e

## TODO: no root check

## NOTE: does not support spaces
replace_list=$(echo "\
([https:// https://
([http:// http://
[https:// https://
[http:// http://
<ref>http:// http://
<ref>https:// https://
</ref>
")

file_name="$1"
test -r "$file_name"

tr -s '[:blank:]' '[\n*]' < "$file_name" | while IFS= read -r word; do
   #echo "word: '$word'"

   if [ "$word" = "" ]; then
      continue
   fi

   if link_result_orig=$(echo "$word" | grep --fixed-string 'https://') ; then
      if echo "$word" | grep --quiet --fixed-string '|image=' ; then
         continue
      fi
      if echo "$word" | grep --quiet --fixed-string 'https://web.archive.org' ; then
         continue
      fi

      #echo "orig: $link_result_orig"

      link_result_cleaned="$link_result_orig"

      if [ "$link_result_cleaned" = "" ]; then
         error
      fi

      while read -r replace_config_line ; do
         if [ "$replace_config_line" = "" ]; then
            echo "ERROR! replace_config_line is empty!"
            exit 1
         fi

         true "replace_config_line: '$replace_config_line'"
         read -r first second <<< "$replace_config_line"

         true "first: $first"
         true "second: $second"

         if [ "$first" = "" ]; then
            echo "ERROR! first is empty!"
            exit 1
         fi
         #if [ "$second" = "" ]; then
            #echo "ERROR! second is empty!"
            #exit 1
         #fi

         link_result_cleaned=$(echo "$link_result_cleaned" | LANG=C str_replace "$first" "$second" 2>/dev/null)
      done < <( echo "$replace_list" )

      echo "clean: '$link_result_cleaned'"

   fi
done

