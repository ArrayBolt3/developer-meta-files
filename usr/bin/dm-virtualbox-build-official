#!/bin/bash

## Copyright (C) 2023 - 2023 ENCRYPTED SUPPORT LP <adrelanos@whonix.org>
## See the file COPYING for copying conditions.

set -x
set -e

true "$0: START"

true "$0: checklist..."
df -h
read press_enter_to_continue

true "$0: checklist..."
ls -la ~/virtualbox-windows-installer-binary/VirtualBox-* || true
read press_enter_to_continue

official_args=()
## Build VirtualBox ova. (amd64 for Windows, Linux, Mac)
official_args+=(--target virtualbox)

## Also build the Whonix Windows Installer.
## TODO: disabled for now until sha512sum overwriting issue was fixed in dm-prepare-release
#official_args+=(--target windows)

official_args+=(--repo true)

## XXX: hardcoded path
cd ~/derivative-maker

./help-steps/signing-key-test

## Build '--flavor whonix-workstation-xfce' first because it is the most
## complex, when used with '--target windows', because:
## - *_prepare-build-machine does git clone virtualbox-windows-installer-binary
## - dm-prepare-release builds Whonix Windows Installer
[ -n "$flavors_list" ] || flavors_list=(
  whonix-workstation-xfce
  whonix-gateway-xfce
  kicksecure-xfce
  whonix-workstation-cli
  whonix-gateway-cli
  kicksecure-cli
)

build_upload_noninteractive=true
export build_upload_noninteractive

for flavor_item in "${flavors_list[@]}"; do
  ./derivative-delete "${official_args[@]}" --flavor "$flavor_item" "$@"
done

for flavor_item in "${flavors_list[@]}"; do
  ./build-steps.d/*_sanity-tests "${official_args[@]}" --flavor "$flavor_item" "$@"
done

./build-steps.d/*_prepare-build-machine "${official_args[@]}" --flavor internal "$@"
./build-steps.d/*_cowbuilder-setup "${official_args[@]}" --flavor internal "$@"
./build-steps.d/*_local-dependencies "${official_args[@]}" --flavor internal "$@"
./build-steps.d/*_create-debian-packages "${official_args[@]}" --flavor internal "$@"

for flavor_item in "${flavors_list[@]}"; do
  ./build-steps.d/*_sanity-tests "${official_args[@]}" --flavor "$flavor_item" "$@"
done

SKIP_SCRIPTS+=" sanity-tests "
SKIP_SCRIPTS+=" prepare-build-machine "
SKIP_SCRIPTS+=" cowbuilder-setup "
SKIP_SCRIPTS+=" local-dependencies "
SKIP_SCRIPTS+=" create-debian-packages "
export SKIP_SCRIPTS

for flavor_item in "${flavors_list[@]}"; do
  ./derivative-maker "${official_args[@]}" --flavor "$flavor_item" "$@"
done

for flavor_item in "${flavors_list[@]}"; do
  if echo "$flavor_item" | grep --quiet "gateway" ; then
    ## Not needed for gateway due to unified images.
    continue
  fi
  dm-prepare-release "${official_args[@]}" --flavor "$flavor_item" "$@"
done

for flavor_item in "${flavors_list[@]}"; do
  if echo "$flavor_item" | grep --quiet "gateway" ; then
    ## Not needed for gateway due to unified images.
    continue
  fi

  if echo "$@" | grep --quiet "remote-derivative-packages true" ; then
    ## Skip upload of debug images.
    echo simulate-echo-only: dm-upload-images "${official_args[@]}" --flavor "$flavor_item" "$@"
    continue
  fi

  dm-upload-images "${official_args[@]}" --flavor "$flavor_item" "$@"
done

true "$0: END"
