#!/bin/bash

## Copyright (C) 2023 - 2023 ENCRYPTED SUPPORT LP <adrelanos@whonix.org>
## See the file COPYING for copying conditions.

set -x
set -e

official_args=()
official_args+=(--target virtualbox)
official_args+=(--repo true)

cd ~/derivative-maker

flavors_list=(
  whonix-workstation-xfce
  whonix-gateway-xfce
  kicksecure-xfce
  whonix-workstation-cli
  whonix-gateway-cli
  kicksecure-cli
)

for flavor_item in "${flavors_list[@]}"; do
  ./derivative-delete "${official_args[@]}" --flavor "$flavor_item" "$@"
done

for flavor_item in "${flavors_list[@]}"; do
  ./build-steps.d/1100_sanity-tests "${official_args[@]}" --flavor "$flavor_item" "$@"
done

./build-steps.d/1120_prepare-build-machine "${official_args[@]}" --flavor internal "$@"
./build-steps.d/1130_cowbuilder-setup "${official_args[@]}" --flavor internal "$@"
./build-steps.d/1140_local-dependencies "${official_args[@]}" --flavor internal "$@"
./build-steps.d/1200_create-debian-packages "${official_args[@]}" --flavor internal "$@"

for flavor_item in "${flavors_list[@]}"; do
  ./build-steps.d/1100_sanity-tests "${official_args[@]}" --flavor "$flavor_item" "$@"
done

SKIP_SCRIPTS+=" 1100_sanity-tests "
SKIP_SCRIPTS+=" 1120_prepare-build-machine "
SKIP_SCRIPTS+=" 1130_cowbuilder-setup "
SKIP_SCRIPTS+=" 1140_local-dependencies "
SKIP_SCRIPTS+=" 1200_create-debian-packages "
export SKIP_SCRIPTS

for flavor_item in "${flavors_list[@]}"; do
  ./derivative-maker "${official_args[@]}" --flavor "$flavor_item" "$@"
done
